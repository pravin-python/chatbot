import random
import asyncio
import requests
import json
from typing import Dict, Any
from app.scripts.multilingual.chatbot.async_utils import AsyncChatbotWrapper

class ResponseGenerator:
    """Response generation logic"""
    
    def __init__(self):
        self.chatbot = AsyncChatbotWrapper(intents_file="app/scripts/intents.json")
        asyncio.create_task(self.chatbot.initialize())

    async def generate_response(self, message: str, user_id: int, product_id: int, chat_history: list = None):
        try:
            analysis = await self.chatbot.analyze_conversation_async(message)
            print(analysis)
            result = analysis['intent_analysis']
            if result['is_confident']:
                if result['intent'] == 'product_ingredients':
                    return "Action: Redirecting to ingredients database... product_ingredients"
                elif result['intent'] == 'product_nutrition':
                    return "Action: Continuing conversation... product_nutrition"
                elif result['intent'] == 'product_harmful_effects':
                    return "Action: Continuing conversation... product_harmful_effects"
                elif result['intent'] == 'product_suitability':
                    return "Action: Continuing conversation... product_suitability"
                elif result['intent'] == 'barcode_information':
                    return "Action: Continuing conversation... barcode_information"
                elif result['intent'] == 'personal_name':
                    return "Action: Continuing conversation... personal_name"
                elif result['intent'] == 'personal_age':
                    return "Action: Continuing conversation.. personal_age."
                elif result['intent'] == 'personal_height':
                    return "Action: Continuing conversation...personal_height"
                elif result['intent'] == 'greeting':
                    return "Action: Continuing conversation... greeting"
                elif result['intent'] == 'how_are_you':
                    return "Action: Continuing conversation... how_are_you"
                elif result['intent'] == 'daily_wellness':
                    return "Action: Continuing conversation... daily_wellness"
                elif result['intent'] == 'product_alternatives':
                    return "Action: Continuing conversation... product_alternatives"
                else:
                    return "⚠️ Action: Intent not recognized. Please try again."
            else:
                return "⚠️ Action: Intent not recognized. Please try again."
            
        except Exception as e:
            return f"I received your message. Thank you for contacting us! {e}"

    async def llm_model_process(self, message: str, chat_history: list = None):
        try:
            api_url = "http://10.0.101.117:11434/api/chat"
            payload = {
                "model": "openchat:7b",
                "messages": [
                    {
                    "role": "system",
                    "content": """
                    You are **FactsScan Buddy** — a friendly AI assistant inside the FactsScan app.  
                    ## Your role:
                        - Help users check if a product (from `product_data`) fits their dietary needs, restrictions, or goals (from `customer_data`).  
                        - Answer ONLY about **food, nutraceuticals, nutrition labels, ingredients, additives, allergens, or suitability**.  
                    
                    ## Important Clarifications:
                        - The JSON block named **product_data** = always the product information (name, ingredients, nutrients, additives, allergens, etc.).  
                        - The JSON block named **customer_data** = always the customer profile (diet, restrictions, allergies, health conditions, preferences, etc.).  
                        - The **user asking the question is always the same as `customer_data`**, not the product.  
                        - Never confuse product details with customer details.  
                        
                    Your job: read product labels (ingredients, nutrients, allergens, additives) and help users check if a product fits their dietary needs, restrictions, or goals.  
                    
                    ❌ Never repeat or rephrase the user's question in the response.  
                    ✅ Only return the actual answer (if in scope) or the fixed denial message (if out of scope).
                    Your only job is to help with **food and nutraceutical products**.  

                    ## Hard Scope Rules:
                        - ✅ Answer ONLY if the user asks about food, nutrition labels, product suitability, diet restrictions, ingredients, or additives.  
                        - ❌ If user asks **anything outside food/nutrition** (sports, math, general knowledge, chit-chat, etc.):  
                            → Always reply exactly:  
                                "This is outside my scope. I can only assist with food and nutraceutical product information."  

                    ### Context:
                    - **Product Data (JSON):** Details of the product.  
                    - **Customer Data (JSON):** Customer profile (diet, likes/dislikes, restrictions, etc.).  
                    - **Conversation History:** Last few user–assistant chats are included.  

                    ### Core Rules:
                    - ✅ Only answer about food, nutraceuticals, ingredients, nutrition, allergens, additives, product suitability.  
                    - ✅ Always adapt to customer’s profile (diet, restrictions, etc.).  
                    - ✅ Reply in the **same language as the user**.  
                    - ✅ Keep answers **very short and chatbot-like** → max 1 line, or 2 very short lines.  
                    - ✅ If asked for medical advice:  
                        → "I'm here to help with product information, not medical advice."  
                    - ✅ If unrelated to food/nutraceuticals:  
                        → "This is outside my scope. I can only assist with food and nutraceutical product information."  
                    - ✅ Warm, short greetings if user says hello/thanks.  
                    - ✅ Be polite if user apologizes.  

                        ## Answer Style:
                        - Keep replies **very short and chatbot-like** (max 1 line, or 2 very short lines).  
                        - Use the **same language** as the user.  
                        - If asked for medical advice:  
                            → "I'm here to help with product information, not medical advice."  
                        - Warm short greetings allowed for "hello/thanks".  
                        - Be polite if user apologizes.    

                    ### Do Not:
                    - ❌ Do NOT answer anything outside food/nutraceutical scope.  
                    - ❌ No medical/health advice.  
                    - ❌ No telling what someone *should* or *should not* eat.  
                    - ❌ No answers outside food/nutraceuticals.  

                    Stick to these rules. You are always **FactsScan Buddy**.
                    """
                    },
                    {
                        "role": "system",
                        "name": "product_data",
                        "content": "{\n  \"name\": \"BALAJI WAFER Aloo Sev,22G\",\n  \"category\": \"Sweets/Snacks\",\n  \"brand\": \"BALAJI\",\n  \"company\": \"BALAJI WAFERS PVT. LTD.\",\n  \"description\": \"BALAJI WAFER Aloo Sev,22G\",\n  \"diet\": \"vg\",\n  \"ingredients\": \"{\\\\\\\"ingredients\\\\\\\":[{\\\\\\\"id\\\\\\\":214957,\\\\\\\"name\\\\\\\":\\\\\\\"Edible Vegetable Oil \\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":\\\\\\\"45\\\\\\\",\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[{\\\\\\\"id\\\\\\\":214958,\\\\\\\"name\\\\\\\":\\\\\\\"Palmolein\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":\\\\\\\"31.5\\\\\\\",\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":2196,\\\\\\\"name\\\\\\\":\\\\\\\"Palmolein\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[{\\\\\\\"id\\\\\\\":5891,\\\\\\\"name\\\\\\\":\\\\\\\"Palmolein\\\\\\\",\\\\\\\"code\\\\\\\":null,\\\\\\\"risk_level\\\\\\\":\\\\\\\"high\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Palmolein is a type of vegetable oil derived from palm oil. It's primarily composed of unsaturated fatty acids, making it a source of dietary fats.  While generally considered safe for consumption, excessive intake of palmolein, like other fats, can contribute to weight gain and potential health issues associated with high fat diets. Palmolein is used widely in food processing for frying and as an ingredient in many products. \\\\\\\"}]}},{\\\\\\\"id\\\\\\\":214959,\\\\\\\"name\\\\\\\":\\\\\\\"Rice Bran\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":\\\\\\\"13.5\\\\\\\",\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":2893,\\\\\\\"name\\\\\\\":\\\\\\\"Rice Bran\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}}],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":427,\\\\\\\"name\\\\\\\":\\\\\\\"Edible Vegetable Oil \\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214960,\\\\\\\"name\\\\\\\":\\\\\\\"Potato Flakes\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"25\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":\\\\\\\"25\\\\\\\",\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":49,\\\\\\\"name\\\\\\\":\\\\\\\"Potato Flakes\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214961,\\\\\\\"name\\\\\\\":\\\\\\\"Chickpea Flour\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"25\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":\\\\\\\"20\\\\\\\",\\\\\\\"sort_index\\\\\\\":2,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":1957,\\\\\\\"name\\\\\\\":\\\\\\\"Chickpea Flour\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214962,\\\\\\\"name\\\\\\\":\\\\\\\"Rice Flour\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":\\\\\\\"10\\\\\\\",\\\\\\\"sort_index\\\\\\\":3,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":176,\\\\\\\"name\\\\\\\":\\\\\\\"Rice Flour\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214963,\\\\\\\"name\\\\\\\":\\\\\\\"Maltodextrin\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":4,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":51,\\\\\\\"name\\\\\\\":\\\\\\\"Maltodextrin\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[{\\\\\\\"id\\\\\\\":3532,\\\\\\\"name\\\\\\\":\\\\\\\"Maltodextrin\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Maltodextrin is a polysaccharide derived from starch. It's often used as a food additive to improve texture, increase sweetness, and act as a bulking agent.  While generally considered safe, excessive consumption might contribute to blood sugar spikes in individuals with diabetes or insulin resistance.  Additionally, some people may experience digestive issues like gas or bloating after ingesting significant amounts.\\\\\\\"}]}},{\\\\\\\"id\\\\\\\":214964,\\\\\\\"name\\\\\\\":\\\\\\\"Edible Common Salt\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":5,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":220,\\\\\\\"name\\\\\\\":\\\\\\\"Edible Common Salt\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[{\\\\\\\"id\\\\\\\":3533,\\\\\\\"name\\\\\\\":\\\\\\\"Sodium Chloride\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Sodium chloride, or common salt, is an essential nutrient for humans, playing a crucial role in maintaining fluid balance, nerve impulse transmission, and muscle contractions.  However, excessive intake of sodium chloride can lead to hypertension (high blood pressure), increasing the risk of heart disease, stroke, and kidney problems.  Moderation is key to reaping its benefits without experiencing adverse health effects.  It's naturally present in many foods but is also heavily used as a preservative and flavor enhancer.\\\\\\\"}]}},{\\\\\\\"id\\\\\\\":214965,\\\\\\\"name\\\\\\\":\\\\\\\"Spices & Condiments\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":6,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[{\\\\\\\"id\\\\\\\":214966,\\\\\\\"name\\\\\\\":\\\\\\\"(dry Mango\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":31564,\\\\\\\"name\\\\\\\":\\\\\\\"(dry Mango\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214967,\\\\\\\"name\\\\\\\":\\\\\\\"Cumin\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":183,\\\\\\\"name\\\\\\\":\\\\\\\"Cumin\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214968,\\\\\\\"name\\\\\\\":\\\\\\\"Fennel\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":2,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":631,\\\\\\\"name\\\\\\\":\\\\\\\"Fennel\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214969,\\\\\\\"name\\\\\\\":\\\\\\\"Chilli\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":3,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":1090,\\\\\\\"name\\\\\\\":\\\\\\\"Chilli\\\\\\\",\\\\\\\"is_fv\\\\\\\":true,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214970,\\\\\\\"name\\\\\\\":\\\\\\\"Coriander\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":4,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":732,\\\\\\\"name\\\\\\\":\\\\\\\"Coriander\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214971,\\\\\\\"name\\\\\\\":\\\\\\\"Clove\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":5,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":563,\\\\\\\"name\\\\\\\":\\\\\\\"Clove\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214972,\\\\\\\"name\\\\\\\":\\\\\\\"Turmeric\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":6,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":540,\\\\\\\"name\\\\\\\":\\\\\\\"Turmeric\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214973,\\\\\\\"name\\\\\\\":\\\\\\\"Pepper\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":7,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":832,\\\\\\\"name\\\\\\\":\\\\\\\"Pepper\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214974,\\\\\\\"name\\\\\\\":\\\\\\\"Cardamom\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":8,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":9,\\\\\\\"name\\\\\\\":\\\\\\\"Cardamom\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214975,\\\\\\\"name\\\\\\\":\\\\\\\"Ginger)\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":9,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":12114,\\\\\\\"name\\\\\\\":\\\\\\\"Ginger)\\\\\\\",\\\\\\\"is_fv\\\\\\\":true,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}}],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":25,\\\\\\\"name\\\\\\\":\\\\\\\"Spices & Condiments\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214976,\\\\\\\"name\\\\\\\":\\\\\\\"Dehydrated Vegetable Powder\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":7,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[{\\\\\\\"id\\\\\\\":214977,\\\\\\\"name\\\\\\\":\\\\\\\"Mint\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"0.2\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":1108,\\\\\\\"name\\\\\\\":\\\\\\\"Mint\\\\\\\",\\\\\\\"is_fv\\\\\\\":true,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214978,\\\\\\\"name\\\\\\\":\\\\\\\"Garlic\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":733,\\\\\\\"name\\\\\\\":\\\\\\\"Garlic\\\\\\\",\\\\\\\"is_fv\\\\\\\":true,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214979,\\\\\\\"name\\\\\\\":\\\\\\\"Tamarindi\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":2,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":31565,\\\\\\\"name\\\\\\\":\\\\\\\"Tamarindi\\\\\\\",\\\\\\\"is_fv\\\\\\\":true,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}}],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":2522,\\\\\\\"name\\\\\\\":\\\\\\\"Dehydrated Vegetable Powder\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}},{\\\\\\\"id\\\\\\\":214980,\\\\\\\"name\\\\\\\":\\\\\\\"Natural & Nature Identical Flavouring Substances\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":8,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[{\\\\\\\"id\\\\\\\":214981,\\\\\\\"name\\\\\\\":\\\\\\\"(Mint)\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":24787,\\\\\\\"name\\\\\\\":\\\\\\\"(Mint)\\\\\\\",\\\\\\\"is_fv\\\\\\\":true,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":0,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}}],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":2473,\\\\\\\"name\\\\\\\":\\\\\\\"Natural & Nature Identical Flavouring Substances\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[{\\\\\\\"id\\\\\\\":3681,\\\\\\\"name\\\\\\\":\\\\\\\"Natural Flavouring Substances\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Natural flavouring substances are compounds derived from natural sources, such as plants, animals, or microorganisms, to enhance the taste or aroma of food products.  These substances can include a wide variety of chemicals, and while generally considered safe, their specific effects on the human body vary. Some may have no significant impact, while others could trigger allergic reactions in susceptible individuals. The long-term effects of consuming a large quantity of natural flavouring substances are not yet fully understood.\\\\\\\"},{\\\\\\\"id\\\\\\\":3526,\\\\\\\"name\\\\\\\":\\\\\\\"Nature Identical Flavouring Substances\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Nature Identical Flavouring Substances are synthetically produced substances that mimic the flavor and aroma of natural ingredients. They are created in a laboratory to match the chemical composition of natural flavors found in fruits, vegetables, and other sources.  These substances are widely used in the food industry to enhance the taste and aroma of processed foods and beverages. While generally considered safe in the amounts typically used, some individuals may experience allergic reactions or sensitivities to specific nature-identical flavoring substances.\\\\\\\"},{\\\\\\\"id\\\\\\\":3635,\\\\\\\"name\\\\\\\":\\\\\\\"Natural Flavours\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Natural flavors are substances derived from natural sources, such as fruits, vegetables, spices, and herbs, that are added to food to enhance its taste and aroma.  They typically consist of complex mixtures of volatile compounds, and their effects on the human body are generally considered safe when consumed in moderate amounts as part of a balanced diet. However, some individuals might have allergic reactions to certain natural flavors, and the potential impact of long-term consumption of large quantities is not fully understood.\\\\\\\"},{\\\\\\\"id\\\\\\\":3529,\\\\\\\"name\\\\\\\":\\\\\\\"Natural Flavors\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Natural flavors are substances derived from natural sources, such as fruits, vegetables, spices, or herbs, used to impart a specific taste or aroma to food products.  They are complex mixtures of various chemical compounds that contribute to the overall sensory experience.  While generally considered safe, some individuals may have allergic reactions to specific natural flavors, depending on their source.  The long-term effects of consuming natural flavors are generally considered minimal, although research in this area is ongoing.\\\\\\\"},{\\\\\\\"id\\\\\\\":4678,\\\\\\\"name\\\\\\\":\\\\\\\"Natural & Nature Identical Flavouring Substances\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"NULL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Natural and nature-identical flavoring substances are compounds that either occur naturally in foods or are artificially synthesized to mimic natural flavors.  These substances are used to enhance the taste and aroma of food products.  While generally safe, certain individuals may be sensitive to specific natural flavors, resulting in allergic reactions or other adverse effects.  The safety and regulation of these substances varies by country and specific compound.\\\\\\\"}]}},{\\\\\\\"id\\\\\\\":214982,\\\\\\\"name\\\\\\\":\\\\\\\"Acidity Regulator (Ins 330, Ins 296)\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":9,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":4977,\\\\\\\"name\\\\\\\":\\\\\\\"Acidity Regulator (Ins 330, Ins 296)\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[{\\\\\\\"id\\\\\\\":3509,\\\\\\\"name\\\\\\\":\\\\\\\"330\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"Citric acid\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"Citric acid is a weak organic acid that occurs naturally in citrus fruits. It's used as a food additive for its sour taste and to preserve food.  In the body, citric acid participates in the Krebs cycle, a key metabolic pathway for energy production. While generally recognized as safe, excessive intake might cause gastrointestinal issues such as upset stomach or heartburn in some sensitive individuals.\\\\\\\"},{\\\\\\\"id\\\\\\\":3558,\\\\\\\"name\\\\\\\":\\\\\\\"296\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"Malic acid, DL\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"INS 296, also known as malic acid, is an organic acid naturally occurring in many fruits, particularly apples and grapes. It acts as an acidity regulator, flavor enhancer, and antioxidant in food products.  Malic acid is generally recognized as safe, though it may affect individuals with pre-existing digestive conditions if consumed in excess.\\\\\\\"}]}},{\\\\\\\"id\\\\\\\":214983,\\\\\\\"name\\\\\\\":\\\\\\\"Flavour Enhancer (Ins 635)\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":10,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":1633,\\\\\\\"name\\\\\\\":\\\\\\\"Flavour Enhancer (Ins 635)\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"medium\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[{\\\\\\\"id\\\\\\\":3828,\\\\\\\"name\\\\\\\":\\\\\\\"635\\\\\\\",\\\\\\\"code\\\\\\\":\\\\\\\"Disodium 5\\\\\\\\u2019-ribonucleotides\\\\\\\",\\\\\\\"risk_level\\\\\\\":\\\\\\\"low\\\\\\\",\\\\\\\"description\\\\\\\":\\\\\\\"INS 635, also known as Calcium Dinatrium EDTA, is a chelating agent commonly used as a food additive to improve the stability and shelf life of products. It binds to metal ions, preventing them from causing undesirable changes in color, flavor, or texture.  While generally considered safe at approved levels, excessive consumption of EDTA might cause some gastrointestinal issues like nausea or diarrhea in susceptible individuals. Long-term effects are not fully understood, but current studies suggest no major health risks at normal usage.\\\\\\\"}]}},{\\\\\\\"id\\\\\\\":214984,\\\\\\\"name\\\\\\\":\\\\\\\"Anticaking Agent (Ins 551, Ins 341 (0)\\\\\\\",\\\\\\\"weightage\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"assumed_weightage\\\\\\\":null,\\\\\\\"sort_index\\\\\\\":11,\\\\\\\"custom_fv_nlm\\\\\\\":\\\\\\\"parent\\\\\\\",\\\\\\\"children\\\\\\\":[],\\\\\\\"ingredient\\\\\\\":{\\\\\\\"id\\\\\\\":31566,\\\\\\\"name\\\\\\\":\\\\\\\"Anticaking Agent (Ins 551, Ins 341 (0)\\\\\\\",\\\\\\\"is_fv\\\\\\\":false,\\\\\\\"is_nlm\\\\\\\":false,\\\\\\\"risk_level\\\\\\\":\\\\\\\"no\\\\\\\",\\\\\\\"is_additive\\\\\\\":1,\\\\\\\"status\\\\\\\":1,\\\\\\\"additives\\\\\\\":[]}}],\\\\\\\"ingredientsString\\\\\\\":\\\\\\\"Edible Vegetable Oil  [Rice Bran], Potato Flakes(25%), Chickpea Flour(25%), Rice Flour, Spices & Condiments [(dry Mango, Cumin, Fennel, Chilli, Coriander, Clove, Turmeric, Pepper, Cardamom, Ginger)], Dehydrated Vegetable Powder [Mint, Garlic, Tamarindi], Natural & Nature Identical Flavouring Substances [(Mint)]\\\\\\\",\\\\\\\"additivesString\\\\\\\":\\\\\\\"Palmolein, Maltodextrin, Sodium Chloride, Natural Flavouring Substances, Nature Identical Flavouring Substances, Natural Flavours, Natural Flavors, Natural & Nature Identical Flavouring Substances, 330, 296, 635\\\\\\\"}\",\n  \"nutrients\": \"[{\\\\\\\"id\\\\\\\":233870,\\\\\\\"name\\\\\\\":\\\\\\\"Energy\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Energy\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_energy\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":true,\\\\\\\"weightage\\\\\\\":618,\\\\\\\"unit\\\\\\\":\\\\\\\"kcal\\\\\\\",\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"children\\\\\\\":[],\\\\\\\"percentage\\\\\\\":\\\\\\\"77.25\\\\\\\",\\\\\\\"type\\\\\\\":\\\\\\\"Negative\\\\\\\",\\\\\\\"baselinePoints\\\\\\\":[0,200,400,600,800],\\\\\\\"label\\\\\\\":\\\\\\\"Too High Calorie\\\\\\\"},{\\\\\\\"id\\\\\\\":233871,\\\\\\\"name\\\\\\\":\\\\\\\"Protein\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Protein\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_protein\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":true,\\\\\\\"weightage\\\\\\\":8.6,\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"children\\\\\\\":[],\\\\\\\"percentage\\\\\\\":\\\\\\\"43.00\\\\\\\",\\\\\\\"type\\\\\\\":\\\\\\\"Positive\\\\\\\",\\\\\\\"baselinePoints\\\\\\\":[0,5,20],\\\\\\\"label\\\\\\\":\\\\\\\"High Protein\\\\\\\"},{\\\\\\\"id\\\\\\\":233872,\\\\\\\"name\\\\\\\":\\\\\\\"Carbohydrates\\\\\\\",\\\\\\\"formatted_name\\\\\\\":[],\\\\\\\"key\\\\\\\":null,\\\\\\\"is_top_nutrients\\\\\\\":false,\\\\\\\"weightage\\\\\\\":\\\\\\\"88.6\\\\\\\",\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":2,\\\\\\\"children\\\\\\\":[{\\\\\\\"id\\\\\\\":233873,\\\\\\\"name\\\\\\\":\\\\\\\"Total Sugars\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Sugar\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_sugar\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":true,\\\\\\\"weightage\\\\\\\":0.7,\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"children\\\\\\\":[],\\\\\\\"percentage\\\\\\\":\\\\\\\"1.67\\\\\\\",\\\\\\\"type\\\\\\\":\\\\\\\"Positive\\\\\\\",\\\\\\\"baselinePoints\\\\\\\":[0,10.5,21,31.5,42],\\\\\\\"label\\\\\\\":\\\\\\\"Low Sugar\\\\\\\"},{\\\\\\\"id\\\\\\\":233874,\\\\\\\"name\\\\\\\":\\\\\\\"Added Sugars\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Sugar\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_sugar\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":false,\\\\\\\"weightage\\\\\\\":\\\\\\\"0.6\\\\\\\",\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"children\\\\\\\":[]}]},{\\\\\\\"id\\\\\\\":233875,\\\\\\\"name\\\\\\\":\\\\\\\"Total Dietary Fiber\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Dietary Fiber\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_dietary_fiber\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":true,\\\\\\\"weightage\\\\\\\":5.5,\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":3,\\\\\\\"children\\\\\\\":[],\\\\\\\"percentage\\\\\\\":\\\\\\\"36.67\\\\\\\",\\\\\\\"type\\\\\\\":\\\\\\\"Positive\\\\\\\",\\\\\\\"baselinePoints\\\\\\\":[0,6,15],\\\\\\\"label\\\\\\\":\\\\\\\"Good Fiber\\\\\\\"},{\\\\\\\"id\\\\\\\":233876,\\\\\\\"name\\\\\\\":\\\\\\\"Total Fat\\\\\\\",\\\\\\\"formatted_name\\\\\\\":[],\\\\\\\"key\\\\\\\":null,\\\\\\\"is_top_nutrients\\\\\\\":false,\\\\\\\"weightage\\\\\\\":\\\\\\\"46.5\\\\\\\",\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":4,\\\\\\\"children\\\\\\\":[]},{\\\\\\\"id\\\\\\\":233877,\\\\\\\"name\\\\\\\":\\\\\\\"Saturated Fat\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Saturated Fat\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_saturated_fat\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":true,\\\\\\\"weightage\\\\\\\":21.4,\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":5,\\\\\\\"children\\\\\\\":[{\\\\\\\"id\\\\\\\":233878,\\\\\\\"name\\\\\\\":\\\\\\\"Trans Fat\\\\\\\",\\\\\\\"formatted_name\\\\\\\":[],\\\\\\\"key\\\\\\\":null,\\\\\\\"is_top_nutrients\\\\\\\":false,\\\\\\\"weightage\\\\\\\":\\\\\\\"0.1\\\\\\\",\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":0,\\\\\\\"children\\\\\\\":[]},{\\\\\\\"id\\\\\\\":233879,\\\\\\\"name\\\\\\\":\\\\\\\"Cholesterol\\\\\\\",\\\\\\\"formatted_name\\\\\\\":[],\\\\\\\"key\\\\\\\":null,\\\\\\\"is_top_nutrients\\\\\\\":false,\\\\\\\"weightage\\\\\\\":\\\\\\\"0\\\\\\\",\\\\\\\"unit\\\\\\\":\\\\\\\"g\\\\\\\",\\\\\\\"sort_index\\\\\\\":1,\\\\\\\"children\\\\\\\":[]}],\\\\\\\"percentage\\\\\\\":\\\\\\\"214.00\\\\\\\",\\\\\\\"type\\\\\\\":\\\\\\\"Negative\\\\\\\",\\\\\\\"baselinePoints\\\\\\\":[0,2.5,5,7.5,10],\\\\\\\"label\\\\\\\":\\\\\\\"Too Fatty\\\\\\\"},{\\\\\\\"id\\\\\\\":233880,\\\\\\\"name\\\\\\\":\\\\\\\"Sodium\\\\\\\",\\\\\\\"formatted_name\\\\\\\":\\\\\\\"Sodium\\\\\\\",\\\\\\\"key\\\\\\\":\\\\\\\"is_sodium\\\\\\\",\\\\\\\"is_top_nutrients\\\\\\\":true,\\\\\\\"weightage\\\\\\\":1206,\\\\\\\"unit\\\\\\\":\\\\\\\"mg\\\\\\\",\\\\\\\"sort_index\\\\\\\":6,\\\\\\\"children\\\\\\\":[],\\\\\\\"percentage\\\\\\\":\\\\\\\"134.00\\\\\\\",\\\\\\\"type\\\\\\\":\\\\\\\"Negative\\\\\\\",\\\\\\\"baselinePoints\\\\\\\":[0,225,450,675,900],\\\\\\\"label\\\\\\\":\\\\\\\"Too Salty\\\\\\\"}]\",\n  \"allergens\": \"{\\\\\\\"allergens\\\\\\\":[],\\\\\\\"allergenString\\\\\\\":\\\\\\\"\\\\\\\"}\",\n  \"tag1\": \"Aloo Sev Namkeen\",\n  \"tag2\": null,\n  \"tag3\": null,\n  \"tag4\": null,\n  \"tag5\": null,\n  \"score_in\": 2,\n  \"grade_in\": \"E\",\n  \"net_weight\": \"22\",\n  \"net_content\": \"22\",\n  \"mass_measurement_unit\": \"Grams\",\n  \"processing_level\": \"Ultra-processed foods\",\n  \"fssai_lic\": \"10012021000039,10012021000037,10016026000857\"\n}"
                    },
                    {
                        "role": "system",
                        "name": "customer_data",
                        "content": "{\n  \"name\": \"pravin\",\n  \"gender\": \"male\",\n  \"age\": 25,\n  \"height\": 5.95,\n  \"weight\": 50.0,\n  \"bmi\": 22.51,\n  \"activity_level\": null,\n  \"health_conditions\": [\n    \"Diabetes\"\n  ],\n  \"diet_preferences\": [\n    \"Vegetarian\",\n    \"Jain\"\n  ],\n  \"allergies\": [\n    \"Nuts\"\n  ]\n}"
                    },

                ],
            }

            if chat_history:
                for chat in chat_history:
                    payload["messages"].append({"role": "user", "content": f"{chat['message']}"})
                    payload["messages"].append({"role": "assistant", "content": f"{chat['response']}"})

            payload["messages"].append({"role": "user", "content": message})
            # response = requests.post(api_url, json=payload)
            # if response.status_code == 200:
            #     data = response.json()
            #     return data["choices"][0]["message"]["content"]
            # else:
            #     return None
            
            # full_response = ""
            # print(api_url)
            # response = requests.post(api_url, json=payload, stream=True)
            # response.raise_for_status()

            # for line in response.iter_lines():
            #     if line:
            #         part = json.loads(line.decode("utf-8"))
            #         if "message" in part and "content" in part["message"]:
            #             full_response += part["message"]["content"]
                
            return message
        
        except Exception as e:
            return "I received your message. Thank you for contacting us!"
        
response_generator = ResponseGenerator()
